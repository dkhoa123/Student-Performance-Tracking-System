@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
@model SPTS_Service.ViewModels.AdminUsersVM

<main class="flex-1 flex flex-col min-w-0 px-6 py-6 lg:px-10">
    @if (TempData["Success"] != null)
    {
        <div class="mb-4 p-4 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-lg flex items-center gap-2">
            <span class="material-symbols-outlined">check_circle</span>
            <span>@TempData["Success"]</span>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="mb-4 p-4 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-lg flex items-center gap-2">
            <span class="material-symbols-outlined">error</span>
            <span>@TempData["Error"]</span>
        </div>
    }
    <div class="max-w-[1200px] mx-auto">
        <!-- Page Heading -->
        <div class="flex flex-wrap justify-between items-end gap-3 mb-8">
            <div class="flex flex-col gap-2">
                <p class="text-[#111418] dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">Quản lý Người dùng</p>
                <p class="text-[#617589] dark:text-[#94a3b8] text-base font-normal leading-normal">Xem và cập nhật thông tin thành viên trong hệ thống.</p>
            </div>
            <button class="flex min-w-[160px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-12 px-6 bg-primary text-white text-sm font-bold shadow-lg shadow-primary/20 hover:bg-primary/90 transition-all">
                <a href="~/Home/SignUp">
                    <span class="material-symbols-outlined">person_add</span>
                    <span class="truncate">Thêm người dùng</span>
                </a>
            </button>
        </div>

        <!-- Search and Filters -->
        <div class="mb-6 bg-white dark:bg-[#1a2632] p-4 rounded-xl shadow-sm border border-[#dbe0e6] dark:border-[#343d48]">
            <!-- Search Box -->
            <form asp-action="quanlyUser" method="get" class="mb-4">
                <input type="hidden" name="role" value="@Model.Role" />
                <input type="hidden" name="page" value="1" />
                <div class="relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#617589] dark:text-[#94a3b8]">search</span>
                    <input type="text"
                           name="keyword"
                           value="@Model.Keyword"
                           placeholder="Tìm kiếm theo tên hoặc email..."
                           class="w-full pl-10 pr-4 py-3 rounded-lg border border-[#dbe0e6] dark:border-[#343d48] bg-white dark:bg-[#25323f] text-[#111418] dark:text-white placeholder-[#617589] dark:placeholder-[#94a3b8] focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>
            </form>

            <!-- Role Filters -->
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex gap-3 flex-wrap">
                    <a asp-action="quanlyUser" asp-route-role="" asp-route-page="1" asp-route-keyword="@Model.Keyword"
                       class="flex h-9 items-center justify-center gap-x-2 rounded-lg px-4 text-sm font-medium @(string.IsNullOrWhiteSpace(Model.Role) ? "bg-primary text-white" : "bg-[#f0f2f4] dark:bg-[#25323f] text-[#111418] dark:text-white hover:bg-[#e2e4e7] dark:hover:bg-[#344452]")">
                        Tất cả
                    </a>
                    <a asp-action="quanlyUser" asp-route-role="STUDENT" asp-route-page="1" asp-route-keyword="@Model.Keyword"
                       class="flex h-9 items-center justify-center gap-x-2 rounded-lg px-4 text-sm font-medium @(Model.Role == "STUDENT" ? "bg-primary text-white" : "bg-[#f0f2f4] dark:bg-[#25323f] text-[#111418] dark:text-white hover:bg-[#e2e4e7] dark:hover:bg-[#344452]")">
                        Sinh viên
                    </a>
                    <a asp-action="quanlyUser" asp-route-role="TEACHER" asp-route-page="1" asp-route-keyword="@Model.Keyword"
                       class="flex h-9 items-center justify-center gap-x-2 rounded-lg px-4 text-sm font-medium @(Model.Role == "TEACHER" ? "bg-primary text-white" : "bg-[#f0f2f4] dark:bg-[#25323f] text-[#111418] dark:text-white hover:bg-[#e2e4e7] dark:hover:bg-[#344452]")">
                        Giảng viên
                    </a>
                    <a asp-action="quanlyUser" asp-route-role="ADMIN" asp-route-page="1" asp-route-keyword="@Model.Keyword"
                       class="flex h-9 items-center justify-center gap-x-2 rounded-lg px-4 text-sm font-medium @(Model.Role == "ADMIN" ? "bg-primary text-white" : "bg-[#f0f2f4] dark:bg-[#25323f] text-[#111418] dark:text-white hover:bg-[#e2e4e7] dark:hover:bg-[#344452]")">
                        Quản trị viên
                    </a>
                </div>
                <div class="flex items-center gap-2 text-sm text-[#617589] dark:text-[#94a3b8]">
                    <span>Hiển thị @Model.From-@Model.To trên @Model.TotalCount người dùng</span>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white dark:bg-[#1a2632] rounded-xl border border-[#dbe0e6] dark:border-[#343d48] overflow-hidden shadow-sm">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-[#f8f9fa] dark:bg-[#25323f] border-b border-[#dbe0e6] dark:border-[#343d48]">
                        <tr>
                            <th class="px-6 py-4 text-[#111418] dark:text-white text-sm font-semibold">Họ và tên</th>
                            <th class="px-6 py-4 text-[#111418] dark:text-white text-sm font-semibold">Email</th>
                            <th class="px-6 py-4 text-[#111418] dark:text-white text-sm font-semibold">Vai trò</th>
                            <th class="px-6 py-4 text-[#111418] dark:text-white text-sm font-semibold text-center">Trạng thái</th>
                            <th class="px-6 py-4 text-[#111418] dark:text-white text-sm font-semibold text-right">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-[#dbe0e6] dark:divide-[#343d48]">
                        @if (Model.Users == null || !Model.Users.Any())
                        {
                            <tr>
                                <td colspan="5" class="px-6 py-12 text-center text-[#617589] dark:text-[#94a3b8]">
                                    Không có người dùng nào
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var user in Model.Users)
                            {
                                <tr class="hover:bg-gray-50 dark:hover:bg-[#212c38] transition-colors">
                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-3">
                                            <div class="size-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-sm">
                                                @user.Initials
                                            </div>
                                            <span class="text-[#111418] dark:text-white font-medium">@user.FullName</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-[#617589] dark:text-[#94a3b8] text-sm">@user.Email</td>
                                    <td class="px-6 py-4">
                                        @{
                                            var roleBadgeClass = user.Role switch
                                            {
                                                "ADMIN" => "bg-primary/10 text-primary",
                                                "TEACHER" => "bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200",
                                                "STUDENT" => "bg-gray-100 dark:bg-[#25323f] text-gray-800 dark:text-gray-200",
                                                _ => "bg-gray-100 dark:bg-[#25323f] text-gray-800 dark:text-gray-200"
                                            };

                                            var roleDisplay = user.Role switch
                                            {
                                                "ADMIN" => "Admin",
                                                "TEACHER" => "Giảng viên",
                                                "STUDENT" => "Sinh viên",
                                                _ => user.Role
                                            };
                                        }
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium @roleBadgeClass">
                                            @roleDisplay
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        @if (user.Status == "ACTIVE")
                                        {
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400">
                                                <span class="w-1.5 h-1.5 rounded-full bg-green-500 mr-1.5"></span>
                                                Hoạt động
                                            </span>
                                        }
                                        else if (user.Status == "LOCKED")
                                        {
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400">
                                                <span class="w-1.5 h-1.5 rounded-full bg-red-500 mr-1.5"></span>
                                                Bị khóa
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-900/30 text-gray-700 dark:text-gray-400">
                                                @user.Status
                                            </span>
                                        }
                                    </td>
                                    <td class="px-6 py-4 text-right">
                                        <div class="flex justify-end gap-2">
                                            <button onclick="openEditModal(@user.UserId)" class="p-2 text-[#617589] hover:text-primary transition-colors">
                                                <span class="material-symbols-outlined text-[20px]">edit</span>
                                            </button>

                                            @if (user.Status == "ACTIVE")
                                            {
                                                <form method="post" asp-action="LockUser" asp-route-id="@user.UserId" asp-route-returnRole="@Model.Role" asp-route-page="@Model.Page" style="display: inline;">
                                                    <button type="submit" class="p-2 text-[#617589] hover:text-red-500 transition-colors" onclick="return confirm('Bạn có chắc muốn khóa người dùng này?')">
                                                        <span class="material-symbols-outlined text-[20px]">lock</span>
                                                    </button>
                                                </form>
                                            }
                                            else
                                            {
                                                <form method="post" asp-action="UnlockUser" asp-route-id="@user.UserId" asp-route-returnRole="@Model.Role" asp-route-page="@Model.Page" style="display:inline;">
                                                    <button type="submit" class="p-2 text-primary hover:text-primary/80 transition-colors" onclick="return confirm('Bạn có chắc muốn mở khóa người dùng này?')">
                                                        <span class="material-symbols-outlined text-[20px]">lock_open</span>
                                                    </button>
                                                </form>
                                            }

                                            <form method="post" asp-action="DeleteUser" asp-route-id="@user.UserId" asp-route-returnRole="@Model.Role" asp-route-page="@Model.Page" style="display: inline;">
                                                <button type="submit" class="p-2 text-[#617589] hover:text-red-600 transition-colors" onclick="return confirm('Bạn có chắc muốn xóa người dùng này? Hành động này không thể hoàn tác!')">
                                                    <span class="material-symbols-outlined text-[20px]">delete</span>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex items-center justify-between p-6 bg-[#f8f9fa] dark:bg-[#25323f] border-t border-[#dbe0e6] dark:border-[#343d48]">
                <div class="text-sm text-[#617589] dark:text-[#94a3b8]">
                    Hiển thị @Model.PageSize trong @Model.TotalCount người dùng
                </div>
                <div class="flex items-center gap-1">
                    @if (Model.Page > 1)
                    {
                        <a asp-action="quanlyUser" asp-route-role="@Model.Role" asp-route-keyword="@Model.Keyword" asp-route-page="@(Model.Page - 1)"
                           class="flex size-9 items-center justify-center rounded-lg hover:bg-gray-200 dark:hover:bg-[#344452] transition-colors text-[#111418] dark:text-white">
                            <span class="material-symbols-outlined text-[20px]">chevron_left</span>
                        </a>
                    }
                    else
                    {
                        <span class="flex size-9 items-center justify-center rounded-lg text-[#617589] cursor-not-allowed">
                            <span class="material-symbols-outlined text-[20px]">chevron_left</span>
                        </span>
                    }

                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        @if (i == 1 || i == Model.TotalPages || (i >= Model.Page - 1 && i <= Model.Page + 1))
                        {
                            <a asp-action="quanlyUser" asp-route-role="@Model.Role" asp-route-keyword="@Model.Keyword" asp-route-page="@i"
                               class="text-sm @(i == Model.Page ? "font-bold flex size-9 items-center justify-center text-white rounded-lg bg-primary" : "font-normal flex size-9 items-center justify-center text-[#111418] dark:text-white rounded-lg hover:bg-gray-200 dark:hover:bg-[#344452] transition-colors")">
                                @i
                            </a>
                        }
                        else if (i == Model.Page - 2 || i == Model.Page + 2)
                        {
                            <span class="text-sm font-normal flex size-9 items-center justify-center text-[#617589]">...</span>
                        }
                    }

                    @if (Model.Page < Model.TotalPages)
                    {
                        <a asp-action="quanlyUser" asp-route-role="@Model.Role" asp-route-keyword="@Model.Keyword" asp-route-page="@(Model.Page + 1)"
                           class="flex size-9 items-center justify-center rounded-lg hover:bg-gray-200 dark:hover:bg-[#344452] transition-colors text-[#111418] dark:text-white">
                            <span class="material-symbols-outlined text-[20px]">chevron_right</span>
                        </a>
                    }
                    else
                    {
                        <span class="flex size-9 items-center justify-center rounded-lg text-[#617589] cursor-not-allowed">
                            <span class="material-symbols-outlined text-[20px]">chevron_right</span>
                        </span>
                    }
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Edit User Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-[#1a2632] rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-[#dbe0e6] dark:border-[#343d48]">
            <div class="flex items-center justify-between">
                <h3 class="text-2xl font-bold text-[#111418] dark:text-white">Chỉnh sửa thông tin người dùng</h3>
                <button onclick="closeEditModal()" class="text-[#617589] hover:text-[#111418] dark:hover:text-white">
                    <span class="material-symbols-outlined text-[24px]">close</span>
                </button>
            </div>
        </div>

        <form id="editForm" class="p-6 space-y-4">
            <input type="hidden" id="edit_userId" name="userId" />

            <div class="space-y-4">
                <!-- Basic Info -->
                <div>
                    <label class="block text-sm font-medium text-[#111418] dark:text-white mb-2">Họ và tên</label>
                    <input type="text" id="edit_fullName" name="fullName" required
                           class="w-full px-4 py-2 rounded-lg border border-[#dbe0e6] dark:border-[#343d48] bg-white dark:bg-[#25323f] text-[#111418] dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-[#111418] dark:text-white mb-2">Email</label>
                    <input type="email" id="edit_email" name="email" required
                           class="w-full px-4 py-2 rounded-lg border border-[#dbe0e6] dark:border-[#343d48] bg-white dark:bg-[#25323f] text-[#111418] dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-[#111418] dark:text-white mb-2">Vai trò</label>
                        <select id="edit_role" name="role" required onchange="toggleCodeFields()"
                                class="w-full px-4 py-2 rounded-lg border border-[#dbe0e6] dark:border-[#343d48] bg-white dark:bg-[#25323f] text-[#111418] dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="STUDENT">Sinh viên</option>
                            <option value="TEACHER">Giảng viên</option>
                            <option value="ADMIN">Admin</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-[#111418] dark:text-white mb-2">Trạng thái</label>
                        <select id="edit_status" name="status" required
                                class="w-full px-4 py-2 rounded-lg border border-[#dbe0e6] dark:border-[#343d48] bg-white dark:bg-[#25323f] text-[#111418] dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="ACTIVE">Hoạt động</option>
                            <option value="LOCKED">Bị khóa</option>
                        </select>
                    </div>
                </div>

                <!-- Cập nhật phần Student fields trong modal -->
                <div id="studentFields" class="col-span-2 hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-[#111418] dark:text-white mb-2">
                            Mã sinh viên <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="edit_studentCode" name="studentCode"
                               class="w-full px-4 py-2 rounded-lg border border-[#dbe0e6] dark:border-[#343d48] bg-white dark:bg-[#25323f] text-[#111418] dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-[#111418] dark:text-white mb-2">
                            Ngành học <span class="text-red-500">*</span>
                        </label>
                        <select id="edit_major" name="major"
                                class="w-full px-4 py-2 rounded-lg border border-[#dbe0e6] dark:border-[#343d48] bg-white dark:bg-[#25323f] text-[#111418] dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">-- Chọn ngành học --</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-[#111418] dark:text-white mb-2">Khóa học</label>
                            <input type="number" id="edit_cohortYear" name="cohortYear"
                                   placeholder="VD: 2024"
                                   min="2000" max="2100"
                                   class="w-full px-4 py-2 rounded-lg border border-[#dbe0e6] dark:border-[#343d48] bg-white dark:bg-[#25323f] text-[#111418] dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-[#111418] dark:text-white mb-2">Khoa</label>
                            <select id="edit_departmentId" name="departmentId"
                                    class="w-full px-4 py-2 rounded-lg border border-[#dbe0e6] dark:border-[#343d48] bg-white dark:bg-[#25323f] text-[#111418] dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="">-- Chọn khoa --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Cập nhật phần Teacher fields -->
                <div id="teacherFields" class="col-span-2 hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-[#111418] dark:text-white mb-2">
                            Mã giảng viên <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="edit_teacherCode" name="teacherCode"
                               class="w-full px-4 py-2 rounded-lg border border-[#dbe0e6] dark:border-[#343d48] bg-white dark:bg-[#25323f] text-[#111418] dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-[#111418] dark:text-white mb-2">Học vị</label>
                            <select id="edit_degree" name="degree"
                                    class="w-full px-4 py-2 rounded-lg border border-[#dbe0e6] dark:border-[#343d48] bg-white dark:bg-[#25323f] text-[#111418] dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="">-- Chọn học vị --</option>
                                <option value="Cử nhân">Cử nhân</option>
                                <option value="Thạc sĩ">Thạc sĩ</option>
                                <option value="Tiến sĩ">Tiến sĩ</option>
                                <option value="Giáo sư">Giáo sư</option>
                            </select>
                        </div>
                        <div>
                        <label class="block text-sm font-medium text-[#111418] dark:text-white mb-2">Khoa</label>
                        <select id="edit_departmentName" name="departmentName"
                                class="w-full px-4 py-2 rounded-lg border border-[#dbe0e6] dark:border-[#343d48] bg-white dark:bg-[#25323f] text-[#111418] dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">-- Chuyên Ngành --</option>
                            <option value="Công nghệ Thông tin">Công nghệ Thông tin</option>
                            <option value="Điện tử Viễn thông">Điện tử Viễn thông</option>
                            <option value="Cơ khí Động lực">Cơ khí Động lực</option>
                            <option value="Quản trị Kinh doanh">Quản trị Kinh doanh</option>
                            <option value="Ngoại ngữ">Ngoại ngữ</option>
                            <option value="Y Dược">Y Dược</option>
                            <option value="Xây dựng">Xây dựng</option>
                            <option value="Hóa học">Hóa học</option>
                            <option value="Môi trường">Môi trường</option>
                        </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Warnings & Errors -->
            <div id="roleChangeWarning" class="hidden p-3 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 rounded-lg text-sm font-medium"></div>
            <div id="errorMessage" class="hidden p-3 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-lg text-sm"></div>

            <!-- Actions -->
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeEditModal()"
                        class="px-6 py-2 rounded-lg border border-[#dbe0e6] dark:border-[#343d48] text-[#111418] dark:text-white hover:bg-gray-50 dark:hover:bg-[#25323f] transition-colors">
                    Hủy
                </button>
                <button type="submit"
                        class="px-6 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 transition-colors">
                    Lưu thay đổi
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // Global variables
        let majorsData = [];
        let departmentsData = [];

        // Load dropdowns data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadMajors();
            loadDepartments();
        });

        function loadMajors() {
            fetch('/Admin/GetMajors')
                .then(response => response.json())
                .then(data => {
                    majorsData = data;
                    const select = document.getElementById('edit_major');
                    select.innerHTML = '<option value="">-- Chọn ngành học --</option>';
                    data.forEach(major => {
                        const option = document.createElement('option');
                        option.value = major.majorCode;
                        option.textContent = major.majorName;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading majors:', error));
        }

        function loadDepartments() {
            fetch('/Admin/GetDepartments')
                .then(response => response.json())
                .then(data => {
                    departmentsData = data;
                    const select = document.getElementById('edit_departmentId');
                    select.innerHTML = '<option value="">-- Chọn khoa --</option>';
                    data.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.departmentId;
                        option.textContent = dept.departmentName;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading departments:', error));
        }

        function toggleCodeFields() {
            const role = document.getElementById('edit_role').value;
            const studentFields = document.getElementById('studentFields');
            const teacherFields = document.getElementById('teacherFields');
            const studentCode = document.getElementById('edit_studentCode');
            const teacherCode = document.getElementById('edit_teacherCode');
            const major = document.getElementById('edit_major');

            if (role === 'STUDENT') {
                studentFields.classList.remove('hidden');
                teacherFields.classList.add('hidden');
                studentCode.required = true;
                major.required = true;
                teacherCode.required = false;
            } else if (role === 'TEACHER') {
                teacherFields.classList.remove('hidden');
                studentFields.classList.add('hidden');
                teacherCode.required = true;
                studentCode.required = false;
                major.required = false;
            } else {
                studentFields.classList.add('hidden');
                teacherFields.classList.add('hidden');
                studentCode.required = false;
                teacherCode.required = false;
                major.required = false;
            }
        }

        function openEditModal(userId) {
            fetch(`/Admin/GetUserDetail?id=${userId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('edit_userId').value = data.userId;
                    document.getElementById('edit_fullName').value = data.fullName;
                    document.getElementById('edit_email').value = data.email;
                    document.getElementById('edit_role').value = data.role;
                    document.getElementById('edit_status').value = data.status;

                    // Student fields
                    document.getElementById('edit_studentCode').value = data.studentCode || '';
                    document.getElementById('edit_major').value = data.major || '';
                    document.getElementById('edit_cohortYear').value = data.cohortYear || new Date().getFullYear();
                    document.getElementById('edit_departmentId').value = data.departmentId || '';

                    // Teacher fields
                    document.getElementById('edit_teacherCode').value = data.teacherCode || '';
                    document.getElementById('edit_degree').value = data.degree || '';
                    document.getElementById('edit_departmentName').value = data.departmentName || '';

                    document.getElementById('edit_role').dataset.oldRole = data.role;

                    toggleCodeFields();
                    document.getElementById('editModal').classList.remove('hidden');
                })
                .catch(error => {
                    alert('Lỗi khi tải thông tin người dùng');
                    console.error(error);
                });
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('roleChangeWarning').classList.add('hidden');
        }

        document.getElementById('edit_role').addEventListener('change', function() {
            const oldRole = this.dataset.oldRole;
            const newRole = this.value;
            const warningDiv = document.getElementById('roleChangeWarning');

            if (oldRole && oldRole !== newRole) {
                let warningText = '';

                if (oldRole === 'STUDENT') {
                    warningText = '⚠️ Chuyển từ Sinh viên sang ' + (newRole === 'TEACHER' ? 'Giảng viên' : 'Admin') + ' sẽ xóa toàn bộ dữ liệu sinh viên (điểm, GPA, lớp học phần). Bạn có chắc chắn?';
                } else if (oldRole === 'TEACHER') {
                    warningText = '⚠️ Chuyển từ Giảng viên sang ' + (newRole === 'STUDENT' ? 'Sinh viên' : 'Admin') + ' sẽ xóa dữ liệu giảng viên. Giảng viên không được có lớp học phần hoặc làm trưởng khoa.';
                } else if (oldRole === 'ADMIN') {
                    warningText = '✅ Chuyển từ Admin sang ' + (newRole === 'STUDENT' ? 'Sinh viên' : 'Giảng viên') + ' sẽ tạo dữ liệu tương ứng. Vui lòng điền đầy đủ thông tin.';
                }

                warningDiv.textContent = warningText;
                warningDiv.classList.remove('hidden');
            } else {
                warningDiv.classList.add('hidden');
            }

            toggleCodeFields();
        });

        document.getElementById('editForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const role = document.getElementById('edit_role').value;
            const formData = {
                userId: parseInt(document.getElementById('edit_userId').value),
                fullName: document.getElementById('edit_fullName').value,
                email: document.getElementById('edit_email').value,
                role: role,
                status: document.getElementById('edit_status').value,
                studentCode: null,
                major: null,
                cohortYear: null,
                departmentId: null,
                teacherCode: null,
                degree: null,
                departmentName: null
            };

            if (role === 'STUDENT') {
                formData.studentCode = document.getElementById('edit_studentCode').value;
                formData.major = document.getElementById('edit_major').value;
                formData.cohortYear = parseInt(document.getElementById('edit_cohortYear').value) || new Date().getFullYear();
                const deptId = document.getElementById('edit_departmentId').value;
                formData.departmentId = deptId ? parseInt(deptId) : null;

                if (!formData.studentCode) {
                    showError('Mã sinh viên không được để trống');
                    return;
                }
                if (!formData.major) {
                    showError('Ngành học không được để trống');
                    return;
                }
            } else if (role === 'TEACHER') {
                formData.teacherCode = document.getElementById('edit_teacherCode').value;
                formData.degree = document.getElementById('edit_degree').value || null;
                formData.departmentName = document.getElementById('edit_departmentName').value || null;

                if (!formData.teacherCode) {
                    showError('Mã giảng viên không được để trống');
                    return;
                }
            }

            // Show loading
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Đang xử lý...';

            fetch('/Admin/UpdateUser', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        showError(data.error || 'Cập nhật thất bại');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                })
                .catch(error => {
                    showError('Có lỗi xảy ra: ' + error.message);
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
        });

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
    </script>
}