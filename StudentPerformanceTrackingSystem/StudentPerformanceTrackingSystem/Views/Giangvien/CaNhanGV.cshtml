@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Layout = "~/Views/Shared/_LayoutGiangVien.cshtml";
}
@model SPTS_Service.ViewModel.GiangvienVm.GiangVienProfileVm

<main class="flex flex-1 flex-col h-full overflow-hidden bg-background-light dark:bg-background-dark relative">
    <header class="flex h-20 items-center justify-between border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/80 px-8 py-4 backdrop-blur-md sticky top-0 z-10">
        <button class="mr-4 md:hidden rounded-lg p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800">
            <span class="material-symbols-outlined">menu</span>
        </button>
        <div class="hidden md:flex flex-1">
            <h1 class="text-xl font-bold text-slate-900 dark:text-white">Thông tin cá nhân</h1>
        </div>
        <div class="flex items-center gap-4 ml-auto">
            <button class="relative rounded-full p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-primary transition-colors">
                <span class="material-symbols-outlined">notifications</span>
                <span class="absolute right-2 top-2 size-2 rounded-full bg-red-500 ring-2 ring-white dark:ring-slate-900"></span>
            </button>
            <div class="size-10 rounded-full border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm">
                <img alt="User Avatar" class="w-full h-full object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuD1wtvA_Bs8rQR21DQaNqy1w8jmS0ar8y-ArwRSSIul6dhg40odsQWKCR4Sjz1Ae3DPwij1KBKUX4i-IANZXnN4Zb5Zob_vjW5s4BGa4hr53beeZnh4hWbDq0-Ye8n9HjbkRmf0CWWhT3-pCDVTRXgpKmCdN_0TSlgYKpd8HskTrwMifiohv1N0Gk0sUVOWNfvA8fYUeUG4mKX61LHgM3jMEe36AWDWWUwaKaUO3AYf5BpSX_0UhRxISgTO_dk3BQwDJM7k1ZVQOhs" />
            </div>
        </div>
    </header>
    <div class="flex-1 overflow-y-auto p-4 md:p-8">
        <div class="mx-auto max-w-4xl space-y-6 pb-10">
            <div class="rounded-3xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-sm overflow-hidden">
                <div class="h-32 bg-gradient-to-r from-primary/20 via-primary/10 to-transparent"></div>
                <div class="px-8 pb-8">
                    <div class="flex flex-col md:flex-row gap-6 items-start -mt-16">
                        <div class="relative">
                            <div class="size-32 rounded-3xl border-4 border-white dark:border-slate-900 bg-white shadow-xl overflow-hidden shrink-0">
                                <img alt="Large Profile Picture" class="w-full h-full object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuD1wtvA_Bs8rQR21DQaNqy1w8jmS0ar8y-ArwRSSIul6dhg40odsQWKCR4Sjz1Ae3DPwij1KBKUX4i-IANZXnN4Zb5Zob_vjW5s4BGa4hr53beeZnh4hWbDq0-Ye8n9HjbkRmf0CWWhT3-pCDVTRXgpKmCdN_0TSlgYKpd8HskTrwMifiohv1N0Gk0sUVOWNfvA8fYUeUG4mKX61LHgM3jMEe36AWDWWUwaKaUO3AYf5BpSX_0UhRxISgTO_dk3BQwDJM7k1ZVQOhs" />
                            </div>
                            <button class="absolute -bottom-2 -right-2 p-2 bg-primary text-white rounded-xl shadow-lg hover:bg-blue-600 transition-colors">
                                <span class="material-symbols-outlined text-[18px]">photo_camera</span>
                            </button>
                        </div>
                        <div class="flex-1 pt-16 md:pt-20">
                            <div class="flex flex-wrap items-center gap-3">
                                @{
                                    var ten = Model.FullName.Split(' ').Last();
                                }
                                <h2 class="text-3xl font-black tracking-tight text-slate-900 dark:text-white">Thầy/Cô @ten</h2>
                                <span class="inline-flex items-center rounded-full bg-primary/10 px-3 py-1 text-xs font-bold text-primary ring-1 ring-inset ring-primary/20">
                                    Giảng viên
                                </span>
                            </div>
                            <p class="text-slate-500 dark:text-slate-400 mt-1">Hệ thống theo dõi hiệu suất học tập - EduTrack</p>
                        </div>
                    </div>
                    <div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div class="flex items-start gap-4 p-4 rounded-2xl border border-slate-50 dark:border-slate-800/50 bg-slate-50/50 dark:bg-slate-800/20">
                                <div class="size-10 rounded-xl bg-white dark:bg-slate-800 shadow-sm flex items-center justify-center text-primary">
                                    <span class="material-symbols-outlined">badge</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Mã số giảng viên</span>
                                    <span class="text-base font-bold text-slate-900 dark:text-white">@Model.TeacherCode</span>
                                </div>
                            </div>
                            <div class="flex items-start gap-4 p-4 rounded-2xl border border-slate-50 dark:border-slate-800/50 bg-slate-50/50 dark:bg-slate-800/20">
                                <div class="size-10 rounded-xl bg-white dark:bg-slate-800 shadow-sm flex items-center justify-center text-primary">
                                    <span class="material-symbols-outlined">school</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Khoa / Bộ môn</span>
                                    <span class="text-base font-bold text-slate-900 dark:text-white">@Model.Department</span>
                                </div>
                            </div>
                            <div class="flex items-start gap-4 p-4 rounded-2xl border border-slate-50 dark:border-slate-800/50 bg-slate-50/50 dark:bg-slate-800/20">
                                <div class="size-10 rounded-xl bg-white dark:bg-slate-800 shadow-sm flex items-center justify-center text-primary">
                                    <span class="material-symbols-outlined">workspace_premium</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Học vị</span>
                                    <span class="text-base font-bold text-slate-900 dark:text-white">@Model.Degree</span>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div class="flex items-start gap-4 p-4 rounded-2xl border border-slate-50 dark:border-slate-800/50 bg-slate-50/50 dark:bg-slate-800/20">
                                <div class="size-10 rounded-xl bg-white dark:bg-slate-800 shadow-sm flex items-center justify-center text-primary">
                                    <span class="material-symbols-outlined">mail</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Email công vụ</span>
                                    <span class="text-base font-bold text-slate-900 dark:text-white">@Model.Email</span>
                                </div>
                            </div>
                            <div class="flex items-start gap-4 p-4 rounded-2xl border border-slate-50 dark:border-slate-800/50 bg-slate-50/50 dark:bg-slate-800/20">
                                <div class="size-10 rounded-xl bg-white dark:bg-slate-800 shadow-sm flex items-center justify-center text-primary">
                                    <span class="material-symbols-outlined">call</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Số điện thoại</span>
                                    <span class="text-base font-bold text-slate-900 dark:text-white">@Model.Phone</span>
                                </div>
                            </div>
                            <div class="flex items-start gap-4 p-4 rounded-2xl border border-slate-50 dark:border-slate-800/50 bg-slate-50/50 dark:bg-slate-800/20">
                                <div class="size-10 rounded-xl bg-white dark:bg-slate-800 shadow-sm flex items-center justify-center text-primary">
                                    <span class="material-symbols-outlined">calendar_today</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Sinh nhật</span>
                                    <span class="text-base font-bold text-slate-900 dark:text-white">@Model.Birthday?.ToString("dd/MM/yyyy")</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-6 shadow-sm">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-3">
                        <div class="size-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500">
                            <span class="material-symbols-outlined">settings</span>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-900 dark:text-white">Quản lý tài khoản</h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Cập nhật thông tin bảo mật và hồ sơ cá nhân</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 w-full sm:w-auto">
                        <button onclick="openPasswordModal()" type="button" class="flex-1 sm:flex-none inline-flex items-center justify-center gap-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-5 py-2.5 text-sm font-bold text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all">
                            <span class="material-symbols-outlined text-[20px]">lock_reset</span>
                            Đổi mật khẩu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Modal Đổi Mật Khẩu -->
<div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
    <div class="bg-white dark:bg-card-dark rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-teal-500 to-teal-600 px-6 py-4">
            <h2 class="text-white text-xl font-bold">Đổi mật khẩu</h2>
        </div>

        <!-- Form -->
        <form id="changePasswordForm" class="p-6">
            <!-- Mật khẩu cũ -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="oldPassword">
                    Mật khẩu cũ (*)
                </label>
                <div class="relative">
                    <input type="password"
                           id="oldPassword"
                           name="oldPassword"
                           required
                           class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-4 py-3 pr-10 text-gray-900 dark:text-white placeholder-gray-400 focus:border-teal-500 focus:outline-none focus:ring-1 focus:ring-teal-500 transition-colors"
                           placeholder="Nhập mật khẩu cũ" />
                    <button type="button"
                            onclick="togglePassword('oldPassword')"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        <span class="material-symbols-outlined text-[20px]">visibility_off</span>
                    </button>
                </div>
            </div>

            <!-- Mật khẩu mới -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="newPassword">
                    Mật khẩu mới (*)
                </label>
                <div class="relative">
                    <input type="password"
                           id="newPassword"
                           name="newPassword"
                           required
                           class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-4 py-3 pr-10 text-gray-900 dark:text-white placeholder-gray-400 focus:border-teal-500 focus:outline-none focus:ring-1 focus:ring-teal-500 transition-colors"
                           placeholder="Nhập mật khẩu mới" />
                    <button type="button"
                            onclick="togglePassword('newPassword')"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        <span class="material-symbols-outlined text-[20px]">visibility_off</span>
                    </button>
                </div>
            </div>

            <!-- Xác nhận mật khẩu -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="confirmPassword">
                    Xác nhận mật khẩu (*)
                </label>
                <div class="relative">
                    <input type="password"
                           id="confirmPassword"
                           name="confirmPassword"
                           required
                           class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-4 py-3 pr-10 text-gray-900 dark:text-white placeholder-gray-400 focus:border-teal-500 focus:outline-none focus:ring-1 focus:ring-teal-500 transition-colors"
                           placeholder="Nhập lại mật khẩu mới" />
                    <button type="button"
                            onclick="togglePassword('confirmPassword')"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        <span class="material-symbols-outlined text-[20px]">visibility_off</span>
                    </button>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex gap-3">
                <button type="button"
                        onclick="closePasswordModal()"
                        class="flex-1 px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium transition-colors">
                    Hủy
                </button>
                <button type="submit"
                        class="flex-1 px-4 py-3 rounded-lg bg-teal-600 hover:bg-teal-700 text-white font-medium shadow-sm transition-colors">
                    ĐỔI MẬT KHẨU
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Mở modal
    function openPasswordModal() {
        document.getElementById('passwordModal').style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent scrolling
    }

    // Đóng modal
    function closePasswordModal() {
        document.getElementById('passwordModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        document.getElementById('changePasswordForm').reset();
    }

    // Toggle hiện/ẩn mật khẩu
    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.nextElementSibling;
        const icon = button.querySelector('span');

        if (field.type === 'password') {
            field.type = 'text';
            icon.textContent = 'visibility';
        } else {
            field.type = 'password';
            icon.textContent = 'visibility_off';
        }
    }

    // Đóng modal khi click bên ngoài
    document.getElementById('passwordModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePasswordModal();
        }
    });

    document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword !== confirmPassword) {
        alert('Mật khẩu mới và xác nhận mật khẩu không khớp!');
        return;
      }

      const token = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]').value;

      fetch('@Url.Action("DoiMatKhau", "Giangvien")', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'RequestVerificationToken': token
        },
        body: JSON.stringify({ oldPassword, newPassword, confirmPassword })
      })
      .then(async res => {
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || 'Đổi mật khẩu thất bại');
        return data;
      })
      .then(() => {
        alert('Đổi mật khẩu thành công!');
        closePasswordModal();
      })
      .catch(err => alert('Lỗi: ' + err.message));
    });
</script>

<form id="antiForgeryForm" style="display:none">
    @Html.AntiForgeryToken()
</form>