@model SPTS_Service.ViewModel.GiangvienVm.ChiTietLopVm
@{
    Layout = "~/Views/Shared/_LayoutGiangvien.cshtml";
}
<main class="flex-1 flex flex-col h-full overflow-y-auto bg-background-light dark:bg-background-dark relative">
    <div class="w-full max-w-[1200px] mx-auto p-4 md:p-8 flex flex-col gap-6 md:gap-8 pb-20">
        <div class="flex flex-col lg:flex-row lg:items-start justify-between gap-6">
            <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                    <h1 class="text-[#111418] dark:text-white text-2xl md:text-3xl font-black leading-tight">@Model.CourseName</h1>
                    @{
                        string statusText = Model.SectionStatus switch
                        {
                            "OPEN" => "Đang học",
                            "UPCOMING" => "Sắp bắt đầu",
                            "FINISHED" => "Đã kết thúc",
                            _ => "Không xác định"
                        };
                    }
                    <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 text-xs font-bold uppercase tracking-wide">@statusText</span>
                </div>
                <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-[#617589] dark:text-gray-400 text-sm font-medium">
                    <span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-[18px]">qr_code</span> @Model.CourseCode</span>
                    <span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-[18px]">calendar_month</span>@Model.TermName</span>
                    <span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-[18px]">location_on</span> @Model.Room</span>
                    <span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-[18px]">schedule</span>@Model.ScheduleText</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button class="flex items-center gap-2 bg-white dark:bg-[#1a2632] border border-[#dbe0e6] dark:border-gray-700 text-[#111418] dark:text-white px-4 py-2 rounded-lg font-medium text-sm hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors shadow-sm">
                    <span class="material-symbols-outlined text-[20px]">file_upload</span>
                    Nhập Excel
                </button>
                <button class="flex items-center gap-2 bg-primary text-white px-4 py-2 rounded-lg font-medium text-sm hover:bg-blue-600 transition-colors shadow-sm">
                    <span class="material-symbols-outlined text-[20px]">save</span>
                    Lưu bảng điểm
                </button>
            </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white dark:bg-[#1a2632] p-4 rounded-xl border border-[#dbe0e6] dark:border-gray-700 shadow-sm flex flex-col gap-1">
                <p class="text-[#617589] dark:text-gray-400 text-xs font-semibold uppercase">Sĩ số lớp</p>
                <div class="flex items-end gap-2">
                    <span class="text-2xl font-bold text-[#111418] dark:text-white">@Model.StudentCount</span>
                    <span class="text-xs text-green-600 font-medium mb-1">sinh viên</span>
                </div>
            </div>
            <div class="bg-white dark:bg-[#1a2632] p-4 rounded-xl border border-[#dbe0e6] dark:border-gray-700 shadow-sm flex flex-col gap-1">
                <p class="text-[#617589] dark:text-gray-400 text-xs font-semibold uppercase">Điểm TB Lớp</p>
                <div class="flex items-end gap-2">
                    <span class="text-2xl font-bold text-primary">@(Model.AverageScore.HasValue? Model.AverageScore.Value.ToString("0.0") : "--")</span>
                    <span class="text-xs text-[#617589] mb-1">/ 10</span>
                </div>
            </div>
            <div class="bg-white dark:bg-[#1a2632] p-4 rounded-xl border border-[#dbe0e6] dark:border-gray-700 shadow-sm flex flex-col gap-1">
                <p class="text-[#617589] dark:text-gray-400 text-xs font-semibold uppercase">Tỷ lệ qua môn</p>
                <div class="flex items-end gap-2">
                    <span class="text-2xl font-bold text-green-600 dark:text-green-400">@Model.PassRatePercent.ToString("0")%</span>
                    <span class="text-xs text-[#617589] mb-1">dự kiến</span>
                </div>
            </div>
            <div class="bg-white dark:bg-[#1a2632] p-4 rounded-xl border border-[#dbe0e6] dark:border-gray-700 shadow-sm flex flex-col gap-1">
                <p class="text-[#617589] dark:text-gray-400 text-xs font-semibold uppercase">Cảnh báo</p>
                <div class="flex items-end gap-2">
                    <span class="text-2xl font-bold text-red-500">@Model.AlertCount</span>
                    <span class="text-xs text-red-500 font-medium mb-1">nguy cơ trượt</span>
                </div>
            </div>
        </div>
        <div class="flex flex-col bg-white dark:bg-[#1a2632] rounded-xl border border-[#dbe0e6] dark:border-gray-700 shadow-sm overflow-hidden">
            <div class="p-4 border-b border-[#dbe0e6] dark:border-gray-700 flex flex-col md:flex-row justify-between gap-4 items-center">
                <form method="get" class="relative w-full md:w-80">
                    <input type="hidden" name="id" value="@Model.SectionId" />
                    <input type="hidden" name="page" value="1" />
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="material-symbols-outlined text-[#617589]">search</span>
                    </div>
                    <input name="search" value="@Model.Search"
                           class="block w-full pl-10 pr-3 py-2 border border-[#dbe0e6] dark:border-gray-600 rounded-lg leading-5 bg-[#f6f7f8] dark:bg-gray-800 text-[#111418] dark:text-white placeholder-[#617589] focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm transition-all"
                           placeholder="Tìm theo tên hoặc MSSV..." />
                </form>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <button type="submit" form="gradeForm" class="flex items-center gap-2 bg-primary text-white px-4 py-2 rounded-lg font-medium text-sm hover:bg-blue-600 transition-colors shadow-sm ring-2 ring-primary/20">
                        <span class="material-symbols-outlined text-[20px]">save</span>
                        Lưu điểm
                    </button>
                    <button class="flex items-center gap-2 text-[#617589] hover:text-primary dark:text-gray-400 dark:hover:text-white px-3 py-2 rounded-lg border border-[#dbe0e6] dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors text-sm font-medium">
                        <span class="material-symbols-outlined text-[18px]">download</span>
                        Xuất Excel
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <form id="gradeForm" asp-action="SaveGrades" asp-controller="Giangvien" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="SectionId" />
                    <input type="hidden" asp-for="CurrentPage" />
                    <input type="hidden" asp-for="Search" />

                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-[#f6f7f8] dark:bg-gray-800 border-b border-[#dbe0e6] dark:border-gray-700">
                                <th class="py-3 px-4 text-xs font-semibold uppercase text-[#617589] dark:text-gray-400 whitespace-nowrap w-16">STT</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase text-[#617589] dark:text-gray-400 whitespace-nowrap w-32">Mã SV</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase text-[#617589] dark:text-gray-400 whitespace-nowrap min-w-[200px]">Họ và Tên</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase text-[#617589] dark:text-gray-400 whitespace-nowrap w-32 text-center">Quá trình</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase text-[#617589] dark:text-gray-400 whitespace-nowrap w-32 text-center">Cuối kỳ</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase text-[#617589] dark:text-gray-400 whitespace-nowrap w-32 text-center">Tổng kết</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase text-[#617589] dark:text-gray-400 whitespace-nowrap w-32">Trạng thái</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase text-[#617589] dark:text-gray-400 whitespace-nowrap w-16"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-[#f0f2f4] dark:divide-gray-800">
                            @for (int i = 0; i < Model.Students.Count; i++)
                            {
                                var st = Model.Students[i];

                                // Avatar = chữ cái đầu của họ tên (VD: Nguyễn Văn An => NA)
                                string initials = "";
                                if (!string.IsNullOrWhiteSpace(st.FullName))
                                {
                                    var parts = st.FullName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
                                    if (parts.Length == 1) initials = parts[0].Substring(0, 1).ToUpper();
                                    else initials = (parts[^2].Substring(0, 1) + parts[^1].Substring(0, 1)).ToUpper(); // lấy 2 từ cuối
                                }

                                // Status badge theo TotalScore
                                bool hasTotal = st.TotalScore.HasValue;
                                bool pass = hasTotal && st.TotalScore.Value >= 5m;

                                string statusText = !hasTotal ? "Chưa đủ điểm" : (pass ? "Đạt" : "Trượt");
                                string statusClass = !hasTotal
                                ? "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
                                : pass
                                ? "bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-400"
                                : "bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-400";

                                // Nếu rớt thì tô viền đỏ giống UI cũ
                                string rowClass = (!hasTotal || pass)
                                ? "hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors group"
                                : "hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors group border-l-2 border-l-red-500";
                                <tr class="@rowClass">
                                    <td class="py-3 px-4 text-sm text-[#617589] dark:text-gray-400">
                                        @(((Model.CurrentPage - 1) * Model.PageSize + i + 1).ToString("D2"))
                                    </td>

                                    <td class="py-3 px-4 text-sm font-medium text-[#111418] dark:text-white">@st.StudentCode</td>

                                    <td class="py-3 px-4">
                                        <div class="flex items-center gap-3">
                                            <div class="size-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">
                                                @initials
                                            </div>
                                            <div class="flex flex-col">
                                                <span class="text-sm font-medium text-[#111418] dark:text-white">@st.FullName</span>
                                                <span class="text-xs text-[#617589] dark:text-gray-500">
                                                    @(st.DateOfBirth?.ToString("dd/MM/yyyy") ?? "")
                                                </span>
                                            </div>
                                        </div>
                                    </td>

                                    <td class="py-3 px-4 text-center">
                                        <input type="hidden" asp-for="Students[i].StudentId" />
                                        <input asp-for="Students[i].ProcessScore"
                                               class="w-20 text-center text-sm py-1 rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-[#111418] dark:text-white focus:ring-1 focus:ring-primary focus:border-primary"
                                               max="10" min="0" step="0.01" type="number" />
                                    </td>

                                    <td class="py-3 px-4 text-center">
                                        <input asp-for="Students[i].FinalScore"
                                               class="w-20 text-center text-sm py-1 rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-[#111418] dark:text-white focus:ring-1 focus:ring-primary focus:border-primary"
                                               max="10" min="0" step="0.01" type="number" />
                                    </td>

                                    <td class="py-3 px-4 text-center">
                                        @if (hasTotal)
                                        {
                                            <span class="text-sm font-bold @(pass ? "text-[#111418] dark:text-white" : "text-red-600 dark:text-red-400")">
                                                @st.TotalScore.Value.ToString("0.0")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-sm font-bold text-[#617589] dark:text-gray-500 italic">--</span>
                                        }
                                    </td>

                                    <td class="py-3 px-4">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium @statusClass">
                                            @statusText
                                        </span>
                                    </td>

                                    <td class="py-3 px-4 text-right">
                                        <button type="button"
                                                class="text-[#617589] hover:text-primary dark:text-gray-400 transition-colors opacity-0 group-hover:opacity-100">
                                            <span class="material-symbols-outlined text-[20px]">edit_note</span>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </form>
            </div>
            @{
                var from = (Model.TotalStudents == 0) ? 0 : ((Model.CurrentPage - 1) * Model.PageSize + 1);
                var to = Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalStudents);

                int prevPage = Math.Max(Model.CurrentPage - 1, 1);
                int nextPage = Math.Min(Model.CurrentPage + 1, Model.TotalPages);

                int window = 2; // hiện 5 trang quanh current
                int start = Math.Max(1, Model.CurrentPage - window);
                int end = Math.Min(Model.TotalPages, Model.CurrentPage + window);
            }

            <div class="p-4 border-t border-[#dbe0e6] dark:border-gray-700 flex items-center justify-between">
                <div class="text-sm text-[#617589] dark:text-gray-400">
                    Hiển thị <span class="font-medium text-[#111418] dark:text-white">@from-@to</span>
                    trong <span class="font-medium text-[#111418] dark:text-white">@Model.TotalStudents</span> sinh viên
                </div>

                <div class="flex gap-2">
                    <a class="px-3 py-1 rounded border border-[#dbe0e6] dark:border-gray-600 text-[#617589] dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 @(Model.CurrentPage == 1 ? "pointer-events-none opacity-50" : "")"
                       asp-action="ChitietLop"
                       asp-route-id="@Model.SectionId"
                       asp-route-page="@prevPage"
                       asp-route-search="@Model.Search">
                        <span class="material-symbols-outlined text-sm">chevron_left</span>
                    </a>

                    @if (start > 1)
                    {
                        <a class="px-3 py-1 rounded border border-[#dbe0e6] dark:border-gray-600 text-[#111418] dark:text-white hover:bg-gray-50 dark:hover:bg-gray-800 text-sm font-medium"
                           asp-action="ChitietLop" asp-route-id="@Model.SectionId" asp-route-page="1" asp-route-search="@Model.Search">1</a>
                        @if (start > 2)
                        {
                            <span class="px-2 py-1 text-[#617589]">…</span>
                        }
                    }

                    @for (int p = start; p <= end; p++)
                    {
                        if (p == Model.CurrentPage)
                        {
                            <span class="px-3 py-1 rounded bg-primary text-white text-sm font-medium">@p</span>
                        }
                        else
                        {
                            <a class="px-3 py-1 rounded border border-[#dbe0e6] dark:border-gray-600 text-[#111418] dark:text-white hover:bg-gray-50 dark:hover:bg-gray-800 text-sm font-medium"
                               asp-action="ChitietLop"
                               asp-route-id="@Model.SectionId"
                               asp-route-page="@p"
                               asp-route-search="@Model.Search">@p</a>
                        }
                    }

                    @if (end < Model.TotalPages)
                    {
                        @if (end < Model.TotalPages - 1)
                        {
                            <span class="px-2 py-1 text-[#617589]">…</span>
                        }
                        <a class="px-3 py-1 rounded border border-[#dbe0e6] dark:border-gray-600 text-[#111418] dark:text-white hover:bg-gray-50 dark:hover:bg-gray-800 text-sm font-medium"
                           asp-action="ChitietLop" asp-route-id="@Model.SectionId" asp-route-page="@Model.TotalPages" asp-route-search="@Model.Search">@Model.TotalPages</a>
                    }

                    <a class="px-3 py-1 rounded border border-[#dbe0e6] dark:border-gray-600 text-[#617589] dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 @(Model.CurrentPage == Model.TotalPages ? "pointer-events-none opacity-50" : "")"
                       asp-action="ChitietLop"
                       asp-route-id="@Model.SectionId"
                       asp-route-page="@nextPage"
                       asp-route-search="@Model.Search">
                        <span class="material-symbols-outlined text-sm">chevron_right</span>
                    </a>
                </div>
            </div>

        </div>

    </div>
</main>