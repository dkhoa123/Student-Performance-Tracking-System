@model SPTS_Service.ViewModel.GiangvienVm.GiangVien
@{
    Layout = "~/Views/Shared/_LayoutGiangVien.cshtml";
}
<!-- Main Content Area -->
<main class="flex flex-1 flex-col h-full overflow-hidden bg-background-light dark:bg-background-dark relative">
    <!-- Scrollable Content -->
    <div class="flex-1 overflow-y-auto p-4 md:p-8">
        <div class="mx-auto max-w-full space-y-8 pb-10">
            <!-- Welcome Heading -->
            <div class="flex flex-col gap-1">
                @{
                    var ten = Model.TeacherName?.Split(' ').Last();
                }
                <h1 class="text-3xl font-black tracking-tight text-slate-900 dark:text-white md:text-4xl">Xin chào, Thầy/Cô @ten 👋</h1>
                <p class="text-base text-slate-500 dark:text-slate-400">Đây là tổng quan tình hình học tập của các lớp hôm nay.</p>
            </div>

            <!-- Stats Row -->
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                <!-- Stat Card 1 -->
                <div class="group relative flex flex-col justify-between overflow-hidden rounded-2xl bg-white dark:bg-slate-900 p-6 shadow-sm border border-slate-100 dark:border-slate-800 transition-all hover:shadow-md hover:border-primary/30">
                    <div class="absolute right-0 top-0 p-4 opacity-10 transition-opacity group-hover:opacity-20">
                        <span class="material-symbols-outlined text-8xl text-primary">groups</span>
                    </div>
                    <div class="relative z-10 flex items-center gap-3">
                        <div class="flex size-10 items-center justify-center rounded-full bg-blue-50 dark:bg-blue-900/30 text-primary">
                            <span class="material-symbols-outlined">school</span>
                        </div>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Tổng số học sinh</p>
                    </div>
                    <div class="relative z-10 mt-4">
                        <p class="text-3xl font-bold text-slate-900 dark:text-white">@Model.TotalStudents</p>
                        <div class="mt-1 flex items-center gap-1 text-xs font-medium text-green-600 dark:text-green-400">
                        </div>
                    </div>
                </div>

                <!-- Stat Card 2 -->
                <div class="group relative flex flex-col justify-between overflow-hidden rounded-2xl bg-white dark:bg-slate-900 p-6 shadow-sm border border-slate-100 dark:border-slate-800 transition-all hover:shadow-md hover:border-emerald-500/30">
                    <div class="absolute right-0 top-0 p-4 opacity-10 transition-opacity group-hover:opacity-20">
                        <span class="material-symbols-outlined text-8xl text-emerald-500">bar_chart</span>
                    </div>
                    <div class="relative z-10 flex items-center gap-3">
                        <div class="flex size-10 items-center justify-center rounded-full bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600">
                            <span class="material-symbols-outlined">functions</span>
                        </div>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Điểm trung bình</p>
                    </div>
                    <div class="relative z-10 mt-4">
                        <p class="text-3xl font-bold text-slate-900 dark:text-white">@Model.AverageScore.ToString("0.0")</p>
                        <div class="mt-1 flex items-center gap-1 text-xs font-medium text-green-600 dark:text-green-400">
                        </div>
                    </div>
                </div>

                <!-- Stat Card 3 -->
                <div class="group relative flex flex-col justify-between overflow-hidden rounded-2xl bg-white dark:bg-slate-900 p-6 shadow-sm border border-slate-100 dark:border-slate-800 transition-all hover:shadow-md hover:border-orange-500/30">
                    <div class="absolute right-0 top-0 p-4 opacity-10 transition-opacity group-hover:opacity-20">
                        <span class="material-symbols-outlined text-8xl text-orange-500">warning</span>
                    </div>
                    <div class="relative z-10 flex items-center gap-3">
                        <div class="flex size-10 items-center justify-center rounded-full bg-orange-50 dark:bg-orange-900/30 text-orange-600">
                            <span class="material-symbols-outlined">priority_high</span>
                        </div>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Cần chú ý</p>
                    </div>
                    <div class="relative z-10 mt-4">
                        <p class="text-3xl font-bold text-slate-900 dark:text-white">@Model.AtRiskStudents</p>
                        <div class="mt-1 flex items-center gap-1 text-xs font-medium text-orange-600 dark:text-orange-400">
                            <span>Học sinh cần hỗ trợ ngay</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart and Alerts Row -->
            <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
                <!-- Chart Section -->
                <div class="lg:col-span-2">
                    <div class="rounded-2xl border border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 p-6 shadow-sm">
                        <div class="mb-6 flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-bold text-slate-900 dark:text-white">Xu hướng điểm số</h3>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Theo dõi sự tiến bộ qua từng học kỳ</p>
                            </div>
                            @if (Model.AvailableTerms != null && Model.AvailableTerms.Any())
                            {
                                <select id="termSelector" class="rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 py-1.5 px-3 text-sm font-medium text-slate-600 dark:text-slate-300 focus:border-primary focus:ring-primary">
                                    @foreach (var term in Model.AvailableTerms)
                                    {
                                        if (term.IsSelected)
                                        {
                                            <option value="@term.TermId" selected>@term.TermName</option>
                                        }
                                        else
                                        {
                                            <option value="@term.TermId">@term.TermName</option>
                                        }
                                    }
                                </select>
                            }
                        </div>
                        <div class="relative h-64 w-full">
                            <canvas id="gpaChart" height="120"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Alert Section -->
                <div class="flex flex-col">
                    <div class="flex flex-col rounded-2xl border border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-sm overflow-hidden">
                        <div class="flex items-center justify-between border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/30 px-6 py-4">
                            <div class="flex items-center gap-2">
                                <span class="flex size-2 rounded-full bg-red-500 animate-pulse"></span>
                                <h3 class="font-bold text-slate-900 dark:text-white">Cảnh báo hiệu suất</h3>
                            </div>
                            <span class="rounded-full bg-red-100 dark:bg-red-900/30 px-2.5 py-0.5 text-xs font-bold text-red-600 dark:text-red-400">
                                @Model.RecentAlerts.Count Mới
                            </span>
                        </div>
                        <div class="flex flex-col divide-y divide-slate-100 dark:divide-slate-800">
                            @if (Model.RecentAlerts != null && Model.RecentAlerts.Any())
                            {
                                @foreach (var alert in Model.RecentAlerts)
                                {
                                    <div class="flex items-start gap-4 p-4">
                                        <div class="flex size-10 items-center justify-center rounded-full"
                                             style="background:@alert.IconColor">
                                            <span class="material-symbols-outlined text-white">
                                                @alert.IconName
                                            </span>
                                        </div>

                                        <div class="flex-1">
                                            <p class="font-bold text-slate-900 dark:text-white">@alert.StudentName</p>
                                            <p class="text-xs text-slate-500 dark:text-slate-400">@alert.Message</p>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="p-8 text-center text-slate-500 dark:text-slate-400">
                                    <span class="material-symbols-outlined text-4xl mb-2">check_circle</span>
                                    <p class="text-sm">Không có cảnh báo nào</p>
                                </div>
                            }
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-800/30 p-3 text-center">
                            <button class="text-xs font-bold text-primary hover:text-blue-700">Xem tất cả cảnh báo</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Classes Grid - FULL WIDTH -->
            <div>
                <div class="mb-4 flex items-center justify-between">
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white">Lớp học của tôi</h3>
                    <a class="text-sm font-semibold text-primary hover:text-blue-600" href="/Giangvien/Lophoc">Xem tất cả</a>
                </div>

                <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                    @if (Model.SectionsByTerm != null && Model.SectionsByTerm.Any())
                    {
                        @foreach (var term in Model.SectionsByTerm)
                        {
                            foreach (var cls in term.Sections)
                            {
                                <a href="/Giangvien/ChitietLop/@cls.SectionId" class="group flex flex-col rounded-2xl border border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 p-5 shadow-sm cursor-pointer transition-all hover:shadow-md hover:border-primary/30">
                                    <div class="mb-4 flex items-start justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="flex size-12 items-center justify-center rounded-xl bg-slate-100 dark:bg-slate-800 text-primary">
                                                <span class="material-symbols-outlined">school</span>
                                            </div>
                                            <div>
                                                <h4 class="font-bold text-slate-900 dark:text-white">@cls.CourseCode</h4>
                                                <p class="text-xs text-slate-500 dark:text-slate-400">
                                                    @cls.CourseName • @cls.Room
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-auto">
                                        <div class="mb-2 flex justify-between text-sm text-slate-600 dark:text-slate-300">
                                            <span>@cls.StudentCount Học sinh</span>
                                            <span class="font-semibold">
                                                @cls.CompletionRate.ToString("0")% Hoàn thành
                                            </span>
                                        </div>

                                        <div class="h-2 w-full rounded-full bg-slate-100 dark:bg-slate-700">
                                            <div class="h-full rounded-full bg-primary transition-all"
                                                 style="width:@cls.CompletionRate%">
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            }
                        }
                    }
                    else
                    {
                        <div class="col-span-full p-8 text-center text-slate-500 dark:text-slate-400">
                            <span class="material-symbols-outlined text-6xl mb-2">school</span>
                            <p>Chưa có lớp học nào</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    const chartLabels = @Html.Raw(Json.Serialize(Model.ChartData.Select(x => x.TermName)));
    const chartValues = @Html.Raw(Json.Serialize(Model.ChartData.Select(x => x.AverageGpa)));

    // Lắng nghe sự kiện thay đổi học kỳ (optional - nếu muốn filter)
    const termSelector = document.getElementById('termSelector');
    if (termSelector) {
        termSelector.addEventListener('change', function() {
            const selectedTermId = this.value;
            // Reload page với term mới hoặc filter chart bằng AJAX
            window.location.href = '?termId=' + selectedTermId;
        });
    }
</script>
<script src="~/js/chart.js"></script>