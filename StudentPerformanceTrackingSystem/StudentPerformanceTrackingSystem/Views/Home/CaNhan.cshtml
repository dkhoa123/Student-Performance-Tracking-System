@using SPTS_Service.ViewModel
@model SPTS_Service.ViewModel.SinhvienVm.SinhVien
<!-- Main Content -->
<main class="flex-1 flex flex-col h-full overflow-y-auto bg-background-light dark:bg-background-dark">
    <div class="flex-1 max-w-[1200px] w-full mx-auto p-4 md:p-8">
        <!-- Page Heading -->
        <div class="flex flex-wrap justify-between gap-3 mb-8">
            <div class="flex flex-col gap-1">
                <h1 class="text-[#111418] dark:text-white text-3xl md:text-4xl font-black leading-tight tracking-[-0.033em]">Hồ sơ cá nhân</h1>
                <p class="text-[#617589] dark:text-gray-400 text-base font-normal leading-normal">Quản lý thông tin cá nhân và bảo mật tài khoản</p>
            </div>
        </div>
        <!-- Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Left Column: Summary Card (4 cols) -->
            <div class="lg:col-span-4">
                <div class="bg-white dark:bg-card-dark rounded-xl p-6 shadow-sm border border-[#e5e7eb] dark:border-gray-800 flex flex-col items-center sticky top-6">
                    <div class="relative group">
                        <div class="bg-center bg-no-repeat bg-cover rounded-full h-32 w-32 mb-4 border-4 border-white dark:border-gray-700 shadow-lg" data-alt="Large profile picture of the student" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDrUF5NGLI0YGRMXt8EMEAZ6fFvRRnJLKkHoDsq_fOOejjroh5Xp1LWdDqV5lG8I6Qv-eqcZ16Fn_DnfEQ4YiJN9HrdTYDBVyuF_cigQQnuzEgtELXa3_VoEamTLPb04DdXfRVMtKTNFC2-2feeiPgqiV40Ww1n_gsYc9OX-xAw1t25f2h0Ehlz0fPgn3lNvy4zSfrMWmT_LV0RH3wKrZIZZLcG3R-5O9ygGofstr0-RvE62b40-ojPmq26xL0PlbOCy2hvOjmyJ3U");'></div>
                        <button aria-label="Upload new photo" class="absolute bottom-4 right-0 bg-primary hover:bg-blue-600 text-white p-2 rounded-full shadow-md transition-colors">
                            <span class="material-symbols-outlined text-[18px]">photo_camera</span>
                        </button>
                    </div>
                    <h2 class="text-[#111418] dark:text-white text-2xl font-bold leading-tight text-center mb-1">@Model.FullName</h2>
                    <p class="text-[#617589] dark:text-gray-400 text-sm text-center mb-4">MSSV: @Model.StudentCode</p>
                    <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-sm font-medium mb-6">
                        @{
                            string status = Model.Status == "ACTIVE" ? "Đang học" : "Tạm nghỉ học";
                        }
                        <span class="w-2 h-2 rounded-full bg-green-600 dark:bg-green-400"></span>
                        @status
                    </span>
                    <div class="w-full flex flex-col gap-4 border-t border-[#e5e7eb] dark:border-gray-800 pt-6">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-[#617589] dark:text-gray-400">
                                <span class="material-symbols-outlined">school</span>
                            </div>
                            <div>
                                <p class="text-xs text-[#617589] dark:text-gray-500">Khoa/Viện</p>
                                <p class="text-sm font-medium text-[#111418] dark:text-gray-200">@Model.Major</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-[#617589] dark:text-gray-400">
                                <span class="material-symbols-outlined">mail</span>
                            </div>
                            <div>
                                <p class="text-xs text-[#617589] dark:text-gray-500">Email trường</p>
                                <p class="text-sm font-medium text-[#111418] dark:text-gray-200 truncate max-w-[200px]">@Model.Email</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Right Column: Edit Form (8 cols) -->
            <div class="lg:col-span-8 flex flex-col gap-6">
                <!-- Main Card -->
                <div class="bg-white dark:bg-card-dark rounded-xl shadow-sm border border-[#e5e7eb] dark:border-gray-800 overflow-hidden">
                    <!-- Tabs -->
                    <div class="border-b border-[#dbe0e6] dark:border-gray-800 px-6">
                        <div class="flex gap-8">
                            <button class="group relative flex flex-col items-center justify-center pt-4 pb-3 focus:outline-none">
                                <p class="text-primary text-sm font-bold leading-normal tracking-[0.015em]">Thông tin chung</p>
                                <div class="absolute bottom-0 h-[3px] w-full bg-primary rounded-t-full"></div>
                            </button>
                        </div>
                    </div>
                    <!-- Form Content -->
                    <div class="p-6 md:p-8">
                        <form asp-action="CaNhan" asp-controller="Home">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <input asp-for="StudentId" type="hidden" />
                                <input asp-for="UserId" type="hidden" />
                                <!-- Full Name -->
                                <div class="col-span-1 md:col-span-2">
                                    <label class="block text-sm font-medium text-[#111418] dark:text-gray-200 mb-2" for="fullname">Họ và tên</label>
                                    <div class="relative">
                                        <input asp-for="FullName" class="w-full rounded-lg border border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-3 text-[#111418] dark:text-white placeholder-gray-400 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-colors" id="fullname" type="text" />
                                    </div>
                                </div>
                                <!-- Date of Birth -->
                                <div>
                                    <label class="block text-sm font-medium text-[#111418] dark:text-gray-200 mb-2" for="dob">Ngày sinh</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">
                                            <span class="material-symbols-outlined text-[20px]">calendar_today</span>
                                        </div>
                                        <input asp-for="DateOfBirth" class="w-full rounded-lg border border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-gray-800 pl-10 pr-4 py-3 text-[#111418] dark:text-white focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-colors" id="dob" type="date" />
                                    </div>
                                </div>
                                <!-- Gender -->
                                <div>
                                    <label class="block text-sm font-medium text-[#111418] dark:text-gray-200 mb-2" for="gender">Giới tính</label>
                                    <div class="relative">
                                        <select asp-for="Gender" class="w-full rounded-lg border border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-3 text-[#111418] dark:text-white focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary appearance-none transition-colors" id="gender">
                                            <option selected="" value="male">Nam</option>
                                            <option value="female">Nữ</option>
                                            <option value="other">Khác</option>
                                        </select>
                                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500">
                                            <span class="material-symbols-outlined">expand_more</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Email -->
                                <div class="col-span-1 md:col-span-2">
                                    <label class="block text-sm font-medium text-[#111418] dark:text-gray-200 mb-2" for="email">Email cá nhân</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">
                                            <span class="material-symbols-outlined text-[20px]">mail</span>
                                        </div>
                                        <input asp-for="Email" class="w-full rounded-lg border border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-gray-800 pl-10 pr-4 py-3 text-[#111418] dark:text-white placeholder-gray-400 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-colors" id="email" type="email" />
                                    </div>
                                </div>
                                <!-- Phone -->
                                <div>
                                    <label class="block text-sm font-medium text-[#111418] dark:text-gray-200 mb-2" for="phone">Số điện thoại</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">
                                            <span class="material-symbols-outlined text-[20px]">call</span>
                                        </div>
                                        <input asp-for="Phone" class="w-full rounded-lg border border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-gray-800 pl-10 pr-4 py-3 text-[#111418] dark:text-white placeholder-gray-400 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-colors" id="phone" type="tel" />
                                    </div>
                                </div>
                                <!-- Identity Number (Disabled) -->
                                <div>
                                    <label class="block text-sm font-medium text-[#111418] dark:text-gray-200 mb-2" for="id_card">MSSV</label>
                                    <div class="relative">
                                        <input class="w-full rounded-lg border border-[#dbe0e6] dark:border-gray-700 bg-gray-100 dark:bg-gray-900 px-4 py-3 text-gray-500 dark:text-gray-500 cursor-not-allowed select-none" disabled="" id="id_card" type="text" value="@Model.StudentCode" />
                                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-400">
                                            <span class="material-symbols-outlined text-[20px]">lock</span>
                                        </div>
                                    </div>
                                    <p class="mt-1 text-xs text-gray-500">Liên hệ phòng đào tạo để chỉnh sửa.</p>
                                </div>
                                <!-- Address -->
                                <div class="col-span-1 md:col-span-2">
                                    <label class="block text-sm font-medium text-[#111418] dark:text-gray-200 mb-2" for="address">Địa chỉ thường trú</label>
                                    <div class="relative">
                                        <div class="absolute top-3 left-0 pl-3 flex items-start pointer-events-none text-gray-500">
                                            <span class="material-symbols-outlined text-[20px]">location_on</span>
                                        </div>
                                        <textarea asp-for="Address" class="w-full rounded-lg border border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-gray-800 pl-10 pr-4 py-3 text-[#111418] dark:text-white placeholder-gray-400 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-colors resize-none" id="address" rows="3">@Model.Address</textarea>
                                    </div>
                                </div>
                            </div>
                            <!-- Action Buttons -->
                            <div class="flex items-center justify-end gap-3 pt-4 border-t border-[#dbe0e6] dark:border-gray-800">

                                <button class="px-6 py-2.5 rounded-lg bg-primary hover:bg-blue-600 text-white font-medium shadow-sm transition-colors flex items-center gap-2" type="submit">
                                    <span class="material-symbols-outlined text-[20px]">save</span>
                                    Lưu thay đổi
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- Security Quick Actions (Optional, fits below main form) -->
                <div class="bg-white dark:bg-card-dark rounded-xl shadow-sm border border-[#e5e7eb] dark:border-gray-800 p-6 flex flex-wrap md:flex-nowrap items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded-full text-red-600 dark:text-red-400">
                            <span class="material-symbols-outlined">shield</span>
                        </div>
                        <div>
                            <h3 class="text-[#111418] dark:text-white font-bold text-lg">Mật khẩu &amp; Bảo mật</h3>
                            <p class="text-[#617589] dark:text-gray-400 text-sm">Cập nhật mật khẩu thường xuyên để bảo vệ tài khoản của bạn.</p>
                        </div>
                    </div>

                    <button onclick="openPasswordModal()" type="button" class="px-4 py-2 rounded-lg border border-[#dbe0e6] dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 text-[#111418] dark:text-white font-medium whitespace-nowrap transition-colors">
                        Đổi mật khẩu
                    </button>

                </div>
            </div>
        </div>
    </div>
</main>

<!-- Modal Đổi Mật Khẩu -->
<div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
    <div class="bg-white dark:bg-card-dark rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-teal-500 to-teal-600 px-6 py-4">
            <h2 class="text-white text-xl font-bold">Đổi mật khẩu</h2>
        </div>

        <!-- Form -->
        <form id="changePasswordForm" class="p-6">
            <!-- Mật khẩu cũ -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="oldPassword">
                    Mật khẩu cũ (*)
                </label>
                <div class="relative">
                    <input type="password"
                           id="oldPassword"
                           name="oldPassword"
                           required
                           class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-4 py-3 pr-10 text-gray-900 dark:text-white placeholder-gray-400 focus:border-teal-500 focus:outline-none focus:ring-1 focus:ring-teal-500 transition-colors"
                           placeholder="Nhập mật khẩu cũ" />
                    <button type="button"
                            onclick="togglePassword('oldPassword')"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        <span class="material-symbols-outlined text-[20px]">visibility_off</span>
                    </button>
                </div>
            </div>

            <!-- Mật khẩu mới -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="newPassword">
                    Mật khẩu mới (*)
                </label>
                <div class="relative">
                    <input type="password"
                           id="newPassword"
                           name="newPassword"
                           required
                           class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-4 py-3 pr-10 text-gray-900 dark:text-white placeholder-gray-400 focus:border-teal-500 focus:outline-none focus:ring-1 focus:ring-teal-500 transition-colors"
                           placeholder="Nhập mật khẩu mới" />
                    <button type="button"
                            onclick="togglePassword('newPassword')"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        <span class="material-symbols-outlined text-[20px]">visibility_off</span>
                    </button>
                </div>
            </div>

            <!-- Xác nhận mật khẩu -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="confirmPassword">
                    Xác nhận mật khẩu (*)
                </label>
                <div class="relative">
                    <input type="password"
                           id="confirmPassword"
                           name="confirmPassword"
                           required
                           class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-4 py-3 pr-10 text-gray-900 dark:text-white placeholder-gray-400 focus:border-teal-500 focus:outline-none focus:ring-1 focus:ring-teal-500 transition-colors"
                           placeholder="Nhập lại mật khẩu mới" />
                    <button type="button"
                            onclick="togglePassword('confirmPassword')"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        <span class="material-symbols-outlined text-[20px]">visibility_off</span>
                    </button>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex gap-3">
                <button type="button"
                        onclick="closePasswordModal()"
                        class="flex-1 px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium transition-colors">
                    Hủy
                </button>
                <button type="submit"
                        class="flex-1 px-4 py-3 rounded-lg bg-teal-600 hover:bg-teal-700 text-white font-medium shadow-sm transition-colors">
                    ĐỔI MẬT KHẨU
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Mở modal
    function openPasswordModal() {
        document.getElementById('passwordModal').style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent scrolling
    }

    // Đóng modal
    function closePasswordModal() {
        document.getElementById('passwordModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        document.getElementById('changePasswordForm').reset();
    }

    // Toggle hiện/ẩn mật khẩu
    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.nextElementSibling;
        const icon = button.querySelector('span');

        if (field.type === 'password') {
            field.type = 'text';
            icon.textContent = 'visibility';
        } else {
            field.type = 'password';
            icon.textContent = 'visibility_off';
        }
    }

    // Đóng modal khi click bên ngoài
    document.getElementById('passwordModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePasswordModal();
        }
    });

    document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword !== confirmPassword) {
        alert('Mật khẩu mới và xác nhận mật khẩu không khớp!');
        return;
      }

      const token = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]').value;

      fetch('@Url.Action("DoiMatKhau", "Home")', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'RequestVerificationToken': token
        },
        body: JSON.stringify({ oldPassword, newPassword, confirmPassword })
      })
      .then(async res => {
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || 'Đổi mật khẩu thất bại');
        return data;
      })
      .then(() => {
        alert('Đổi mật khẩu thành công!');
        closePasswordModal();
      })
      .catch(err => alert('Lỗi: ' + err.message));
    });
</script>

<form id="antiForgeryForm" style="display:none">
    @Html.AntiForgeryToken()
</form>